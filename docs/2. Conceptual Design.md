## ERD

![ERD](2.%20ER%20Diagram.drawio.png)
1. avg_score & rating_counts 为派生属性，不在物理表格中存储，由Rates表格聚合得到
2. 为了安全性，存储密码的哈希值而不是密码明文
3. 一个用户只能给一个Topic评分一次，所有有 Unique(user_id, topic_id)

## 关系模式设计 Relational Scheme

```sql
CREATE TABLE User (
  user_id       INT        PRIMARY KEY AUTO_INCREMENT,
  username      VARCHAR(50) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  nickname      VARCHAR(50)  NOT NULL,
  role          VARCHAR(20)  DEFAULT 'user',
  created_at    DATETIME     NOT NULL
);

```


```sql
CREATE TABLE Topic (
  topic_id    INT          PRIMARY KEY AUTO_INCREMENT,
  name        VARCHAR(100) NOT NULL UNIQUE,
  description VARCHAR(255),
  created_at  DATETIME     NOT NULL
);
```
如果决定“实时计算平均分”，可以不在表里放 avg_score 和 rating_count，只用聚合查询 AVG(score) / COUNT(*) 即可。

```sql
CREATE TABLE Post (
  post_id    INT           PRIMARY KEY AUTO_INCREMENT,
  author_id  INT           NOT NULL,
  title      VARCHAR(200)  NOT NULL,
  content    TEXT          NOT NULL,
  is_deleted TINYINT(1)    NOT NULL DEFAULT 0,
  created_at DATETIME      NOT NULL,
  updated_at DATETIME      NOT NULL,
  CONSTRAINT fk_post_user
    FOREIGN KEY (author_id) REFERENCES User(user_id)
);

```
实现时可以给 created_at 建索引，方便按时间查列表。

```sql
CREATE TABLE Comment (
  comment_id INT          PRIMARY KEY AUTO_INCREMENT,
  post_id    INT          NOT NULL,
  author_id  INT          NOT NULL,
  content    TEXT         NOT NULL,
  is_deleted TINYINT(1)   NOT NULL DEFAULT 0,
  created_at DATETIME     NOT NULL,
  CONSTRAINT fk_comment_post
    FOREIGN KEY (post_id) REFERENCES Post(post_id),
  CONSTRAINT fk_comment_user
    FOREIGN KEY (author_id) REFERENCES User(user_id)
);

```
实现时可以给 created_at 建索引，方便按时间查列表。

```sql
CREATE TABLE Rating (
  rating_id  INT          PRIMARY KEY AUTO_INCREMENT,
  user_id    INT          NOT NULL,
  topic_id   INT          NOT NULL,
  score      INT          NOT NULL,
  comment    VARCHAR(255),
  created_at DATETIME     NOT NULL,
  updated_at DATETIME     NOT NULL,
  CONSTRAINT fk_rating_user
    FOREIGN KEY (user_id) REFERENCES User(user_id),
  CONSTRAINT fk_rating_topic
    FOREIGN KEY (topic_id) REFERENCES Topic(topic_id),
  CONSTRAINT uq_rating_user_topic
    UNIQUE (user_id, topic_id),
  CONSTRAINT ck_rating_score
    CHECK (score BETWEEN 1 AND 5)
);

```
`UNIQUE (topic_id, user_id)` 实现“一位用户对同一主题最多一个评分”的业务规则。



