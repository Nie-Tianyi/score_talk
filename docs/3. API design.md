## 1. 认证模块 Auth

> 前缀：`/api/v1/auth`
> 说明：登录成功后返回 `access_token`，之后在请求头里带：
> `Authorization: Bearer <access_token>`

| 功能           | 方法   | 路径                      | 权限 | 请求体                                                                | 响应体                                                           |
| ------------ | ---- | ----------------------- | -- | ------------------------------------------------------------------ | ------------------------------------------------------------- |
| 用户注册         | POST | `/api/v1/auth/register` | 公共 | JSON：`{ username, password, nickname, role? }`                     | `UserOut`：`{ user_id, username, nickname, role, created_at }` |
| 用户登录获取 Token | POST | `/api/v1/auth/token`    | 公共 | **表单**：`username`, `password`（`application/x-www-form-urlencoded`） | `Token`：`{ access_token, token_type }`                        |

---

## 2. 用户模块 Users

> 前缀：`/api/v1/users`

| 功能         | 方法  | 路径                 | 权限   | 请求体 | 响应体              |
| ---------- | --- | ------------------ | ---- | --- | ---------------- |
| 获取当前登录用户信息 | GET | `/api/v1/users/me` | 登录用户 | 无   | `UserOut`：当前用户信息 |
| 列出全部用户     | GET | `/api/v1/users`    | 管理员  | 无   | `PaginatedResponse<UserOut>` 分页用户列表 |

---

## 3. 主题 & 打分模块 Topics & Ratings

> 前缀：`/api/v1/topics`

| 功能         | 方法   | 路径                                  | 权限   | 请求体                                                       | 响应体                                                                                    |
| ---------- | ---- | ----------------------------------- | ---- | --------------------------------------------------------- | -------------------------------------------------------------------------------------- |
| 创建主题       | POST | `/api/v1/topics`                    | 管理员  | JSON：`{ name, description? }`                             | `TopicOut`：`{ topic_id, name, description, created_at }`                               |
| 列出所有主题     | GET  | `/api/v1/topics`                    | 公共   | 查询参数：`page`, `size`（分页参数）                              | `PaginatedResponse<TopicOut>` 分页主题列表                                                    |
| 获取单个主题详情   | GET  | `/api/v1/topics/{topic_id}`         | 公共   | 路径参数：`topic_id`                                           | `TopicOut`                                                                             |
| 获取主题评分统计   | GET  | `/api/v1/topics/{topic_id}/stats`   | 公共   | 路径参数：`topic_id`                                           | `TopicStats`：`{ topic_id, avg_score, rating_count }`                                   |
| 对主题评分/更新评分 | POST | `/api/v1/topics/{topic_id}/ratings` | 登录用户 | JSON：`{ topic_id, score, comment? }`，其中 `topic_id` 应与路径一致 | `RatingOut`：`{ rating_id, user_id, topic_id, score, comment, created_at, updated_at }` |
| 查看某主题下所有评分 | GET  | `/api/v1/topics/{topic_id}/ratings` | 公共   | 路径参数：`topic_id`，查询参数：`page`, `size`（分页参数）             | `PaginatedResponse<RatingOut>` 分页评分列表                                                 |

说明：

* 同一用户对同一 `topic_id` 最多存在一条评分记录；再次调用 POST 会更新之前的评分与短评。
* `score` 取值范围为 `1–5`。
* 分页参数：`page`（页码，从1开始，默认为1），`size`（每页数量，默认为10）。

---

## 4. 帖子 & 评论模块 Posts & Comments

> 前缀：`/api/v1/posts`

| 功能         | 方法     | 路径                                 | 权限       | 请求体                       | 响应体                                                                                    |
| ---------- | ------ | ---------------------------------- | -------- | ------------------------- | -------------------------------------------------------------------------------------- |
| 发表帖子       | POST   | `/api/v1/posts`                    | 登录用户     | JSON：`{ title, content }` | `PostOut`：`{ post_id, author_id, title, content, is_deleted, created_at, updated_at }` |
| 查看帖子列表     | GET    | `/api/v1/posts`                    | 公共       | 查询参数：`page`, `size`（分页参数）    | `PaginatedResponse<PostOut>` 分页帖子列表（只返回 `is_deleted = false` 的帖子）                       |
| 查看帖子详情     | GET    | `/api/v1/posts/{post_id}`          | 公共       | 路径参数：`post_id`            | `PostOut`（如果被逻辑删除则返回 404）                                                              |
| 删除帖子（逻辑删除） | DELETE | `/api/v1/posts/{post_id}`          | 帖子作者或管理员 | 路径参数：`post_id`            | 无内容，HTTP 204                                                                           |
| 发表评论       | POST   | `/api/v1/posts/{post_id}/comments` | 登录用户     | JSON：`{ content }`        | `CommentOut`：`{ comment_id, post_id, author_id, content, is_deleted, created_at }`     |
| 查看帖子下的评论列表 | GET    | `/api/v1/posts/{post_id}/comments` | 公共       | 路径参数：`post_id`            | `CommentOut[]`（只返回 `is_deleted = false` 的评论）                                           |

---

## 5. 主要请求/响应数据结构（简要，用来放在文档附录）

### 5.1 分页参数

**PaginationParams（分页查询参数）**

```jsonc
{
  "page": 1,        // 页码，从1开始，默认为1
  "size": 10         // 每页数量，默认为10
}
```

**PaginatedResponse（分页响应格式）**

```jsonc
{
  "items": [],       // 数据列表
  "total": 100,      // 总记录数
  "page": 1,         // 当前页码
  "size": 10,        // 每页数量
  "pages": 10        // 总页数
}
```

### 5.2 用户

**UserCreate（注册请求）**

```jsonc
{
  "username": "string",
  "password": "string, >=6位",
  "nickname": "string",
  "role": "user 或 admin（可选，建议仅管理员创建时指定）"
}
```

**UserOut（用户响应）**

```jsonc
{
  "user_id": 1,
  "username": "alice",
  "nickname": "Alice",
  "role": "user",
  "created_at": "2025-11-30T08:00:00Z"
}
```

**Token（登录响应）**

```jsonc
{
  "access_token": "JWT 字符串",
  "token_type": "bearer"
}
```

---

### 5.3 主题 & 评分

**TopicCreate**

```jsonc
{
  "name": "孙笑川",
  "description": "关于孙笑川本人的综合评分"
}
```

**TopicOut**

```jsonc
{
  "topic_id": 1,
  "name": "孙笑川",
  "description": "关于孙笑川本人的综合评分",
  "created_at": "2025-11-30T08:00:00Z"
}
```

**TopicStats**

```jsonc
{
  "topic_id": 1,
  "avg_score": 1.73,
  "rating_count": 42
}
```

**RatingCreate**

```jsonc
{
  "topic_id": 1,
  "score": 1,
  "comment": "天皇陛下 desu！"
}
```

**RatingOut**

```jsonc
{
  "rating_id": 10,
  "user_id": 3,
  "topic_id": 1,
  "score": 1,
  "comment": "天皇陛下 desu！",
  "created_at": "2025-11-30T08:00:00Z",
  "updated_at": "2025-11-30T08:00:00Z"
}
```

---

### 5.4 帖子 & 评论

**PostCreate**

```jsonc
{
  "title": "关于孙笑川评分的小讨论",
  "content": "大家来说说为什么你给他打这个分。"
}
```

**PostOut**

```jsonc
{
  "post_id": 5,
  "author_id": 3,
  "title": "关于孙笑川评分的小讨论",
  "content": "大家来说说为什么你给他打这个分。",
  "is_deleted": false,
  "created_at": "2025-11-30T08:00:00Z",
  "updated_at": "2025-11-30T08:00:00Z"
}
```

**CommentCreate**

```jsonc
{
  "content": "我觉得 1 分都给多了。"
}
```

**CommentOut**

```jsonc
{
  "comment_id": 7,
  "post_id": 5,
  "author_id": 3,
  "content": "我觉得 1 分都给多了。",
  "is_deleted": false,
  "created_at": "2025-11-30T08:00:00Z"
}
```

---

## 6. 权限控制与错误处理

### 6.1 权限控制策略

* **认证方式**：JWT + Bearer Token
* **权限级别**：
  * 公共：无需认证即可访问
  * 登录用户：需要提供有效的JWT令牌
  * 管理员：需要提供管理员角色的JWT令牌
  * 资源拥有者：需要是资源的创建者（如帖子作者、评论作者）

### 6.2 常见错误响应

**401 Unauthorized**
```jsonc
{
  "detail": "Not authenticated"
}
```

**403 Forbidden**
```jsonc
{
  "detail": "Not enough permissions"
}
```

**404 Not Found**
```jsonc
{
  "detail": "Resource not found"
}
```

**422 Validation Error**
```jsonc
{
  "detail": [
    {
      "loc": ["body", "username"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

---

* 认证方式：JWT + Bearer Token
* 权限控制策略：基于 `role`（user/admin）+ 资源拥有者（作者）
* 分页支持：所有列表接口均支持分页，使用 `page` 和 `size` 参数
* 软删除：帖子和评论使用软删除机制，通过 `is_deleted` 字段标记 。